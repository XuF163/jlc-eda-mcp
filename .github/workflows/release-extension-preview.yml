name: Release EDA Extension (Preview)

on:
  push:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    concurrency:
      group: release-eda-extension-preview
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install
        run: npm ci

      - name: Resolve versions (current + previous)
        id: versions
        shell: bash
        run: |
          CHANGELOG="packages/eda-extension/CHANGELOG.md"
          mapfile -t VERS < <(grep -Eo '^##[[:space:]]+v?[0-9]+\.[0-9]+\.[0-9]+' "$CHANGELOG" | head -n 2 | sed -E 's/^##[[:space:]]+v?//')

          CURRENT="${VERS[0]}"
          PREVIOUS="${VERS[1]}"

          if [[ -z "$CURRENT" ]]; then
            echo "Failed to parse current version from ${CHANGELOG}" >&2
            exit 1
          fi
          if [[ -z "$PREVIOUS" ]]; then
            echo "Failed to parse previous version from ${CHANGELOG} (need at least 2 version sections)" >&2
            exit 1
          fi

          echo "current=${CURRENT}" >> "$GITHUB_OUTPUT"
          echo "previous=${PREVIOUS}" >> "$GITHUB_OUTPUT"

          echo "CURRENT_VERSION=${CURRENT}" >> "$GITHUB_ENV"
          echo "PREVIOUS_VERSION=${PREVIOUS}" >> "$GITHUB_ENV"
          echo "CURRENT_TAG=v${CURRENT}" >> "$GITHUB_ENV"
          echo "PREVIOUS_TAG=v${PREVIOUS}" >> "$GITHUB_ENV"

      - name: Sync versions from changelog
        shell: bash
        run: |
          node - <<'NODE'
          const fs = require('node:fs')
          const nextVersion = process.env.CURRENT_VERSION
          if (!nextVersion) throw new Error('Missing CURRENT_VERSION')

          const path = 'package.json'
          const raw = fs.readFileSync(path, 'utf8')
          const next = raw.replace(/"version"\s*:\s*"[^"]*"/, `"version": "${nextVersion}"`)
          if (next !== raw) fs.writeFileSync(path, next, 'utf8')
          console.log('Root version ->', nextVersion)
          NODE

          npm run version:sync
          node ./scripts/check-versions.mjs

      - name: Update current version tag to HEAD
        uses: actions/github-script@v7
        env:
          CURRENT_TAG: ${{ env.CURRENT_TAG }}
        with:
          script: |
            const { owner, repo } = context.repo
            const tag = process.env.CURRENT_TAG
            const sha = context.sha

            if (!tag) throw new Error('Missing CURRENT_TAG')

            try {
              await github.rest.git.updateRef({ owner, repo, ref: `tags/${tag}`, sha, force: true })
              core.info(`Updated tag ${tag} -> ${sha}`)
            } catch (e) {
              // GitHub returns 422 when ref doesn't exist for updateRef.
              if (e.status !== 404 && e.status !== 422) throw e

              try {
                await github.rest.git.createRef({ owner, repo, ref: `refs/tags/${tag}`, sha })
                core.info(`Created tag ${tag} -> ${sha}`)
              } catch (e2) {
                // If it was created concurrently, retry update.
                if (e2.status === 422) {
                  await github.rest.git.updateRef({ owner, repo, ref: `tags/${tag}`, sha, force: true })
                  core.info(`Updated tag ${tag} -> ${sha}`)
                  return
                }
                throw e2
              }
            }

      - name: Build EDA extension
        run: npm run build:ext

      - name: Prepare asset
        shell: bash
        run: |
          ASSET="jlceda-mcp-bridge_v${CURRENT_VERSION}.eext"
          SRC="packages/eda-extension/build/dist/${ASSET}"

          if [[ ! -f "$SRC" ]]; then
            echo "Missing asset: $SRC" >&2
            ls -la packages/eda-extension/build/dist || true
            exit 1
          fi

          mkdir -p artifacts
          cp "$SRC" "artifacts/${ASSET}"
          echo "EEXT_ASSET=artifacts/${ASSET}" >> "$GITHUB_ENV"
          echo "Built: artifacts/${ASSET}" >> "$GITHUB_STEP_SUMMARY"

      - name: Update Preview GitHub Release (current)
        uses: actions/github-script@v7
        env:
          CURRENT_TAG: ${{ env.CURRENT_TAG }}
          CURRENT_VERSION: ${{ env.CURRENT_VERSION }}
          EEXT_ASSET: ${{ env.EEXT_ASSET }}
        with:
          script: |
            const fs = require('node:fs')
            const { owner, repo } = context.repo

            const tag = process.env.CURRENT_TAG
            const version = process.env.CURRENT_VERSION
            const assetPath = process.env.EEXT_ASSET

            if (!tag) throw new Error('Missing CURRENT_TAG')
            if (!version) throw new Error('Missing CURRENT_VERSION')
            if (!assetPath) throw new Error('Missing EEXT_ASSET')
            if (!fs.existsSync(assetPath)) throw new Error(`Asset not found: ${assetPath}`)

            const assetName = `jlceda-mcp-bridge_v${version}.eext`
            const now = new Date().toISOString()
            const body = [
              `Preview build for \`${version}\`.`,
              ``,
              `- Commit: ${context.sha}`,
              `- Built at (UTC): ${now}`,
              ``,
              `This release is updated on every push to the default branch.`,
            ].join('\n')

            let release
            try {
              release = (await github.rest.repos.getReleaseByTag({ owner, repo, tag })).data
            } catch (e) {
              if (e.status !== 404) throw e
              release = (await github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: tag,
                target_commitish: context.sha,
                name: `${tag} (Preview)`,
                prerelease: true,
                generate_release_notes: true,
              })).data
            }

            release = (await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: release.id,
              name: `${tag} (Preview)`,
              prerelease: true,
              body,
            })).data

            // Keep only one asset on the preview release.
            for (const a of (release.assets || [])) {
              await github.rest.repos.deleteReleaseAsset({ owner, repo, asset_id: a.id })
            }

            const data = fs.readFileSync(assetPath)
            await github.rest.repos.uploadReleaseAsset({
              owner,
              repo,
              release_id: release.id,
              name: assetName,
              data,
              headers: {
                'content-type': 'application/octet-stream',
                'content-length': data.length,
              },
            })

            core.info(`Uploaded ${assetName} to ${tag}`)

      - name: Promote previous version to Stable
        uses: actions/github-script@v7
        env:
          PREVIOUS_TAG: ${{ env.PREVIOUS_TAG }}
        with:
          script: |
            const tag = process.env.PREVIOUS_TAG
            const { owner, repo } = context.repo

            try {
              const { data } = await github.rest.repos.getReleaseByTag({ owner, repo, tag })

              if (!data.prerelease && data.name === tag) {
                core.info(`${tag} already stable`)
                return
              }

              await github.rest.repos.updateRelease({
                owner,
                repo,
                release_id: data.id,
                prerelease: false,
                name: tag,
              })

              core.info(`Promoted ${tag} to stable`)
            } catch (e) {
              if (e.status === 404) {
                core.info(`No release for ${tag}; skip promotion`)
                return
              }
              throw e
            }
